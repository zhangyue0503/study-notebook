<html>
<head>
  <title>大型网站技术架构核心原理与案例分析</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/608449 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
	body, td {
	  font-family: 微软雅黑;
	  font-size: 12pt;
	}
  </style>
</head>
<body>
<a name="2081"/>
<h1>大型网站技术架构核心原理与案例分析</h1>

<div>
<span><div><b><font style="font-size: 24px;">一、大型网站架构演化</font></b></div><div><b>A.大型网站软件系统的特点</b></div><div>高并发，大流量；高可用；海量数据；用户分布广泛，网络情况复杂；安全环境恶劣；需求快速变更，发布频繁；渐进式发展；</div><div><br/></div><div><b>B.大型网站架构演化发展历程</b></div><div>1.初始阶段：一台服务器，LNMP</div><div>2.应用服务和数据服务分离：应用服务器（CPU）；数据库服务器（快速磁盘检索和数据缓存）；文件服务器（大硬盘）；</div><div>3.使用缓存改善网站性能：缓存在应用服务器上的本地缓存（访问速度快，受应用服务器内存限制，数据量有限）、远程分布式缓存（使用集群部署大内存的服务器作为专门的缓存服务器）</div><div>4.应用服务器集群：通过负载均衡调度</div><div>5.数据库读写分离</div><div>6.使用反向代理和CDN加速：CDN（部署在最近的网络机房）、反向代理 （部署在中心机房）</div><div>7.使用分布式文件系统和分布式数据库系统</div><div>8.使用NoSQL和搜索引擎</div><div>9.业务拆分</div><div>10.分布式服务</div><div><br/></div><div><b>C.大型网站架构演化的价值观</b></div><div>1.大型网站架构技术的核心价值是随网站所需灵活应对</div><div>2.驱动大型网站技术发展的主要力量是网站的业务发展</div><div><br/></div><div><b>D.网站架构设计误区</b></div><div>1.一味追随大公司的解决方案</div><div>2.为了技术而技术</div><div>3.企图用技术解决所有问题：技术是用来解决业务问题的，而业务的问题，也可以通过业务的手段去解决</div><div><br/></div><div><b><font style="font-size: 24px;">二、大型网站架构模式</font></b></div><div>模式：每一个模式描述了一个在我们周围不断重复发生的问题及该问题解决方案的核心。这样，你就能一次又一次地使用该方案而不必做重复工作。模式的关键在于模式的可重复性。</div><div><b>A.网站架构模式</b></div><div>1.分层</div><div><ul><li>分层：是企业应用系统中最常见的一种架构模式，将系统在横向维度上切分成几个部分，每个部分负责一部分相对比较单一的职责，然后通过上层对下层的依赖和调用组成一个完整的系统。<br/></li><li>将网站软件系统分为应用层（视图层、业务逻辑层）、服务层（数据接口层、逻辑处理层）、数据层<br/></li><li>可以更好地将一个庞大的软件系统切分成不同的部分，便于分工合作开发和维护；各层之间具有一定的独立性，只要维持调用接口不变，各层可以根据具体问题独立深化发展而不需要其他层必须 做出相应调整。<br/></li></ul></div><div>2.分割</div><div><ul><li>纵向方面进行切分。将不同的功能和服务分割开来，包装成高内聚低耦合的模块单元。大型网站分割的粒度可能会很小。<br/></li></ul></div><div>3.分布式</div><div><ul><li>即将不同的模块部署在不同的服务器上，通过远程调用协同工作。意味着可以使用更多的计算机完成同样的功能。<br/></li><li>问题：通过网络可能会对性能造成严重影响；服务器多宕机的概率大；数据在分布式的环境中保持数据一致性也非常困难；导致网站依赖错综复杂开发被处理维护困难；<br/></li><li>常见的分布式方案：分布式应用和服务；分布式静态资源；分布式数据和存储；分布式计算（Hadoop及其MapReduce）；分布式配置；分布式锁；分布式文件等；<br/></li></ul></div><div>4.集群</div><div><ul><li>多台服务器部署相同应用构成一个集群，通过负载均衡设备共同对外提供服务。<br/></li></ul></div><div>5.缓存</div><div><ul><li>缓存就是将数据有些话在距离计算最近的位置以加快处理速度。<br/></li><li>CDN、反向代理、本地缓存、分布式缓存。<br/></li><li>使用缓存的两个前提条件：一是数据访问热点不均衡；二是数据在某个时间段内有效；<br/></li></ul></div><div>6.异步</div><div><ul><li>业务之间的消息传递不是同步调用，而是将一个业务操作分成多个阶段，每个阶段之间通过共享数据的方式异步执行进行协作。<br/></li><li>单一服务器内部可通过多线程共享内存队列的方式实现异步；分布式系统中，多个服务器集群通过分布式消息队列实现异步。<br/></li><li>典型的生产者消费者模式，两者不存在直接调用，特性：提高系统可用性；加快网站响应速度；消除并发访问高峰。<br/></li><li>使用异步方式处理业务可能会对用户体验、业务流程造成影响，需要产品设计方面的支持。<br/></li></ul></div><div>7.冗余</div><div><ul><li>要想保证在服务器宕机的情况下网站依然可以继续服务，不丢失数据，就需要一定程度的服务器冗余运行，数据冗余备份。<br/></li><li>小型网站也需要至少两台服务器构建集群，数据库除定期备份保存实现冷备份外，也需要进行主从分享实时同步热备。<br/></li><li>大型公司可能会对整个数据中心备份并同步到各地灾备中心。<br/></li></ul></div><div>8.自动化</div><div><ul><li>主要集中在发布运维方面。<br/></li><li>发布过程自动化：自动化代码管理、自动化测试、自动化安全检测、自动化部署。<br/></li><li>自动化监控：自动化报警、自动化失效转移、自动化失效恢复、自动化降级、自动化分配资源。<br/></li></ul></div><div>9.安全</div><div><br/></div><div><b>B.架构模式在新浪微博的应用</b></div><div><br/></div><div><b><font style="font-size: 24px;">三、大型网站核心架构要素</font></b></div><div>架构：最高层次的规划，难以改变的决定。</div><div>软件架构：有关软件整体结构与组件的抽象描述，用于指导大型软件系统各个方面的设计。</div><div><b>A.性能</b></div><div><ul><li>浏览器端：浏览器缓存、页面压缩、合理布局、减少Cookie传输、CDN等<br/></li><li>应用服务器端：服务器本地缓存、分布式缓存、异步操作与消息队列配合、集群等<br/></li><li>代码：多线程、改善内存管理等<br/></li><li>数据库：索引、缓存、SQL优化、NoSQL技术<br/></li></ul></div><div><br/></div><div><b>B.可用性</b></div><div><ul><li>服务器、数据库及文件存储等运行环境的主要手段是冗余。<br/></li><li>软件开发时通过预发布验证、自动化测试、自动化发布、灰度发布等手段<br/></li></ul></div><div><br/></div><div><b>C.伸缩性</b></div><div><ul><li>伸缩性是指通过不断向集群中加入服务器的手段来缓解不断上升的用户并发访问压力和不断增长的数据存储需求。加入新的服务器是否可以提供和原来的服务器无差别的服务。<br/></li><li>应用服务器：通过合适的负载均衡设备可以向集群中不断加入服务器。<br/></li><li>缓存服务器：加入新的可能会导致缓存路由失效。需要路由算法。<br/></li><li>关系数据库：通过路由分区等手段。<br/></li></ul></div><div><br/></div><div><b>D.扩展性</b></div><div><ul><li>衡量标准：网站增加业务产品时，是否可以实现对现有产品透明无影响；不同产品这间是否很少耦合；<br/></li><li>手段：事件驱动架构（消息队列）、分布式服务（将业务和可利用服务分享，通过分布式服务框架调用）<br/></li></ul></div><div><br/></div><div><b>E.安全性</b></div><div><br/></div><div><b><font style="font-size: 24px;">四、瞬时响应：网站的高性能架构</font></b></div><div><b>A.网站性能测试</b></div><div>1.不同视角</div><div><ul><li>用户视角的网站性能：优化页面HTML样式、利用浏览器端的并发和异步特性、调整浏览器缓存策略、使用CDN服务、反射代理等。<br/></li><li>开发人员视角的网站性能：使用缓存加速数据读取、使用集群提高吞吐能力、使用异步消息加快请求响应及实现削峰、使用代码优化手段改善程序性能。<br/></li><li>运维人员视角的网站性能：建设优化骨干网、使用高性价比定制服务器、利用虚拟化技术优化资源利用等。<br/></li></ul></div><div>2.性能测试指标</div><div><ul><li>响应时间：测试办法是重复请求，测试一万次总时间之和除以一万。<br/></li><li>并发数：系统能够同时处理请求的数目（网站系统用户数&gt;&gt;网站在线用户数&gt;&gt;网站并发用户数），测试程序通过多线程模拟并发用户的办法来测试系统的并发处理能力。<br/></li><li>吞吐量：单位时间内系统处理的请求数量（TPS、HPS、QPS等）<br/></li><li>性能计数器：描述服务器或操作系统性能的一些数据操纵杆。包括System Load、对象与线程数、内存使用、CPU使用、磁盘与网络I/O等。<br/></li></ul></div><div>3.性能测试方法：性能测试、负载测试、压力测试、稳定性测试</div><div>4.性能测试是一个不断对系统增加访问压力，以获得系统性能指标、最大负载能力、最大压力承受能力的过程。所谓增加访问压力，就是不断增加测试程序的并发请求数。</div><div>5.性能优化策略</div><div><ul><li>性能分析：检查请求处理的各个环节的日志，分析哪个环节响应时间不合理、超过预期；然后检查监控数据 。<br/></li></ul></div><div><br/></div><div><b>B.Web前端性能优化</b></div><div>1.浏览器访问优化：减少http请求（合并CSS/JS/图片）、使用浏览器缓存（HTTP头中Cache-Control和Expires）、启用压缩 （Gzip）、CSS放在页面最上面JS放在页面最下面、减少Cookie传输</div><div>2.CND加速</div><div>3.反向代理：通过配置缓存功能加速Web请求。（还可以保护真实服务器及实现负载均衡的功能）</div><div><br/></div><div><b>C.应用服务器性能优化</b></div><div>1.分布式缓存</div><div><ul><li>网站性能优化第一定律：优先考虑使用缓存优化性能<br/></li><li>主要用来存放那些读写比很高、很少变化的数据。缓存无法命中时读取数据库并将数据再写入缓存。<br/></li></ul></div><div>2.合理使用缓存：不要频繁修改的数据、没有热点的访问、数据不一致与脏读、缓存可用性（缓存热备）、缓存预热（在程序启动时预先加载一些缓存）、缓存穿透</div><div>3.分布式缓存架构：需要更新同步的分布式缓存（JBoss Cache）、不互相通信的分布式缓存（Memcached）</div><div>4.异步操作：使用消息队列（可改善网站的扩展性和性能），具有很好的削峰作用，将短时间高并发产生的事务消息存储在消息队列中。</div><div>5.使用集群</div><div>6.代码优化：</div><div><ul><li>多线程（IO阻塞与多CPU，启动线程数=[任务执行时间/(任务执行时间-IO等待时间)]*CPU内核数，需要注意线程安全：将对象设计为无状态对象、使用局部对象、并发访问资源时使用锁）；<br/></li><li>资源复用（单例和对象池）；<br/></li><li>数据结构；<br/></li><li>垃圾回收<br/></li></ul></div><div><br/></div><div><b>D.存储性能优化</b></div><div>1.数据库多采用两级索引的B+树，树的层次最多三层。可能需要5次磁盘访问才能更新一条记录。</div><div>2.这么多NoSQL产品使用LSM树，可以看作一个N阶合并树。</div><div>3.RAID（廉价磁盘冗余阵列），RAID0，RAID1，RAID10，RAID5，RAID6，传统关系数据库及文件系统中应用广泛。</div><div>4.HDFS（Hadoop分布式文件系统），配合MapReduce进行大数据处理。</div><div><br/></div><div><b><font style="font-size: 24px;">五、万无一失：网站的高可用架构</font></b></div><div><b>A.网站可用性的度量与考核</b></div><div>1.网站可用性度量</div><div><ul><li>网站不可用时间（故障时间）=故障修复时间点-故障发现（报告）时间点<br/></li><li>网站年度可用性指标=（1-网站不可用时间/年度总时间）*100%<br/></li><li>2个9是基本可用，88小时；3个9是较高可用，9小时；4个9是具有自动恢复能力的高可用，53分钟；5个9具有极高可用性，小于5分钟；QQ为99.99，4个9，一年大约53分钟不可用。<br/></li></ul></div><div>2.网站可用性考核</div><div><ul><li>故障分：指对网站故障进行分类加权计算故障责任的方法<br/></li><li>故障分=故障时间（分钟）*故障权重<br/></li></ul></div><div><br/></div><div><b>B.高可用的网站架构</b></div><div>主要手段就是数据和服务的冗余备份及失效转移。对于应用层和服务层，以集群通过负载均衡实现高可用，数据层通过数据同步复制实现冗余备份来实现高可用。</div><div><br/></div><div><b>C.高可用应用</b></div><div>1.通过负载均衡进行无状态服务的失效转移：即使应用访问量非常少，也至少部署两台服务器使用负载均衡构建一个小型集群。</div><div>2.应用服务器集群的Session管理</div><div><ul><li>Session复制：服务器间同步Session，小型集群<br/></li><li>Session绑定：利用源地址Hash将源于同一IP的请求分发到同一台服务器上，对高可用性有影响。<br/></li><li>利用Cookie记录Session：大小限制、每次请求响应都需要传输、关闭cookie则无法访问<br/></li><li>Session服务器：利用分布式缓存、数据库等，高可用、高伸缩、性能较好<br/></li></ul></div><div><br/></div><div><b>D.高可用服务</b></div><div>1.分级管理：运维上将服务器进行分级，核心应用和服务优先使用更好的硬件，在运维响应速度上也格外迅速。</div><div>2.超时设置：在应用程序中设置服务调用的超时时间，一旦超时，通信框架就抛出异常，应用程序根据服务调度策略，可选择继续重试或将请求转移到提供相同服务的其他服务器上。</div><div>3.异步调用：应用对服务的调用通过消息队列等异步方式完成，避免一个服务失败导致整个应用请求失败的情况。</div><div>4.服务降级：拒绝服务，拒绝低优先级应用的调用或者随机拒绝部分请求调用；关闭功能，关闭部分不重要的服务或服务内部关闭部分不重要的功能。</div><div>5.幂等性设计：在服务层保证服务重复调用和调用一次产生的结果相同，即服务具有幂等性。</div><div><br/></div><div><b>E.高可用的数据</b></div><div>1.CAP原理</div><div><ul><li>高可用的数据：数据持久性（永久性存储、备份副本不会丢失）、数据可访问性（不同设备下快速切换）、数据一致性（多副本的情况下保证副本数据一致）<br/></li><li>CAP原理：一个提供数据服务的存储系统无法同时满足数据一致性（Consistency）、数据可用性（Availibility）、分区耐受性（Partition Tolerance，系统具有 跨网络分区的伸缩性）这三个条件。<br/></li><li>大型网站通常会选择强化分布式系统的可用性（A）和伸缩性（P），而在某种程度上放弃一致性（C）。一般来说，数据不一致通常出现在系统高并发写操作或者集群状态不稳的情况下，应用系统需要对分布式数据处理系统的数据不一致性有所了解并进行一定意义上的补偿和纠错，以避免出现应用系统数据不正确。<br/></li><li>数据一致性又可分为：数据强一致（各种操作都是一致的）、数据用户一致（副本可能不一致但用户访问时通过纠错的校验确定一个正确的数据返回给用户）、数据最终一致（副本和用户访问可能都不一致，但系统经过一段时间的自我恢复和修正达到一致）<br/></li></ul></div><div>2.数据备份</div><div><ul><li>异步热备：多份数据副本的写入操作异步完成，应用程序收到数据服务系统的写操作成功响应时，只写成功一份，存储系统将会异步地写其他副本（可能会失败）<br/></li><li>同步热备：多份数据副本的写入操作同步完成，即应用程序收到数据服务系统的写成功响应时，多份数据都已经写操作成功。<br/></li></ul></div><div>3.失效转移</div><div><ul><li>失效确认：心跳检测、应用程序访问失败<br/></li><li>访问转移：确认某台服务器宕机后，将数据读写访问重新路由到其他服务器上<br/></li><li>数据恢复：从健康的服务器复制数据，将数据副本数目恢复到设定值<br/></li></ul></div><div><br/></div><div><b>F.高可用网站的软件质量保证</b></div><div>1.网站发布</div><div>2.自动化测试：工具Selenium</div><div>3.预发布验证：先发布到预发布机器上，开发工程师和测试工程师在预发布服务器上进行预发布验证。需要和生产环境相同配置、环境、数据中心等</div><div>4.代码控制：svn、git；主干开发、分支发布；分支开发、主干发布（主流）；</div><div>5.自动化发布</div><div>6.灰度发布：将集群服务器分成若干部分，每天只发布一部分服务器，观察运行稳定没有故障，期间如果发现问题，只需要回滚已发布的一部分服务器即可。也常用于用户测试（AB测试）。</div><div><br/></div><div><b>G.网站运行监控</b></div><div>1.监控数据的采集</div><div><ul><li>用户行为日志收集：用户操作系统与浏览器版本、IP地址、页面访问路径、页面停留时间等。包括服务器端日志收集、客户端浏览器日志收集。<br/></li><li>服务器性能收集：如系统Load、内存占用、磁盘IO、网络IO等，工具Ganglia等<br/></li><li>运行数据报告：如缓冲命中率、平均响应延迟时间、每分钟发送邮件数目、待处理的任务总数等。<br/></li></ul></div><div>2.监控管理</div><div><ul><li>系统报警：设定各项监控指标设定阈值，使用邮件、即时通信工具、短信等报警<br/></li><li>失效转移：主动通知应用，进行失效转移<br/></li><li>自动优雅降级：根据监控参数判断应用负载，适当卸载应用低负载应用部分服务器，重新安装高负载应用使应用负载总体均衡。<br/></li></ul></div><div><br/></div><div><b><font style="font-size: 24px;">六、永无止境：网站的伸缩性架构</font></b></div><div>所谓网站的伸缩性是指不需要改变网站的软硬件设计，仅仅通过改变部署的服务器数量就可以扩大或者缩小网站的服务处理能力。</div><div><b>A.网站架构的伸缩性设计</b></div><div>1.不同功能进行物理分离实现伸缩：纵向分离（分层后分离），将业务处理流程上的不同部分分离部署，实现系统伸缩性；横向分离（业务分割后分离），将不同的业务模块分离部署，实现系统伸缩性。</div><div>2.单一功能通过集群规模实现伸缩</div><div><br/></div><div><b>B.应用服务器集群的伸缩性设计</b></div><div>1.应用服务器应该设计成无状态的，不存储请求上下文信息。</div><div>2.负载均衡：</div><div><ul><li>HTTP重定向负载均衡：根据用户的HTTP请求计算一台真实的Web服务器地址，并将该服务器地址写入HTTP重定向响应中返回给用户浏览器。优点简单，缺点：需要两次请求；重定向服务器自身的处理能力可能成为瓶颈；302跳转可能影响SEO。<br/></li><li>DNS域名解析负载均衡：在DNS服务器配置多个A记录指向不同IP，优点是将负载均衡的工作转交给DNS，不少还支持地理位置返回最近的服务器。缺点是可能缓存A记录，控制权在域名服务商那里。<br/></li><li>反射代理负载均衡：浏览器访问请求的地址是反向代理服务器，反向代理服务器收到请求后，根据负载均衡算法计算得到一台真实物理服务器的地址，并将请求转发给真实服务器，处理完成后将响应返回给反向代理服务器，反向代理服务器再将响应返回给用户。也叫应用层（HTTP层）负载均衡。优点是部署简单，缺点是反向代理服务器作为中转站性能可能成为瓶颈。<br/></li><li>IP负载均衡：用户请求数据包到达负载均衡服务器后，负载均衡服务器在操作系统内核进程获取网络数据包，根据负载均衡算法计算得到一台真实web服务器，然后将数据目的IP地址修改为真实服务器，不需要通过用户进程处理。真实服务器处理完成后，响应数据包回到负载均衡服务器，负载均衡服务器再将数据包源地址修改为自身的IP地址发送给用户浏览器。<br/></li><li>数据链路层负载均衡：三角传输模式，负载均衡服务器数据分发过程中不修改IP地址，只修改目的mac地址，通过所有服务器的虚拟IP地址与负载均衡服务器的IP地址一致，不修改数据包的源地址和目的地址，由于IP一致，可将响应数据包直接返回给用户浏览器。又称为直接路由方式（DR）。代表产品LVS（Linux Virtual Server）。<br/></li></ul></div><div>3.负载均衡算法：</div><div><ul><li>轮询（Round Robin，RR）：所有请求集资分发到每台应用服务器上<br/></li><li>加权轮询（Weighted Round Robin，WRR）：根据服务器硬件性能情况，在轮询的基础上按照配置的权重进行分发<br/></li><li>随机（Random）：请求被随机分配到各个应用服务器<br/></li><li>最少连接（Least Connections）：记录服务器正在处理的连接数，将新的请求分发到最少连接的服务器上<br/></li><li>源地址散列（Source Hashing）：根据请求来源的IP地址进行Hash计算<br/></li></ul></div><div><br/></div><div><b>C.分布式缓存集群的伸缩性设计</b></div><div>1.Memcached分布式缓存集群的访问模型</div><div>通过KEY输入路由算法模块，路由算法计算得到一台Memcached服务器，进行读取和写入。</div><div>2.Memcached分布式缓存集群的伸缩性挑战</div><div>简单的路由算法使用余数Hash：用服务器数目除缓存数据KEY的Hash值，余数为服务器列表下标编号。伸缩性不好。</div><div>3.分布式缓存的<b>一致性Hash算法</b></div><div>先构造一个长度为2的32次方的整数环（一致性Hash环），根据节点名称的Hash值将缓存服务器节点放置在这个Hash环上。然后根据需要缓存的数据的KEY值计算Hash值，然后在Hash环上顺时针查找距离这个KEY的Hash值最近的缓存服务器节点，完成KEY到服务器的Hash映射查找 。</div><div><br/></div><div><b>D.数据存储服务器集群的伸缩性设计</b></div><div>1.关系数据库集群的伸缩性设计</div><div>数据复制（主从）、分表分库、数据分片（
Cobar）</div><div>2.NoSQL数据库的伸缩性设计</div><div>NoSQL放弃了以关系代数为基础的结构化查询语言（SQL）和事务一致性保证（ACID）。强化了高可用性和伸缩性。（Apache HBase）</div><div><br/></div><div><b><font style="font-size: 24px;">七、随需应变：网站的可扩展架构</font></b></div><div><b>扩展性（Extensibility）：</b>指对现有系统影响最小的情况下，系统功能可持续扩展或提升的能力。是系统架构设计层面的开闭原则，架构设计考虑未来功能扩展，当系统增加新功能时，不需要对现有系统的结构和代码进行修改。</div><div><b>伸缩性（Scalability）：</b>指系统能够通过增加（减少）自身资源规模的方式增强（减少）自己计算处理事务的能力。</div><div><b>A.构建可扩展的网站架构</b></div><div>1.软件架构师最大的价值不在于掌握多少先进的技术，而在于具有将一个大系统切分成N个低耦合的子模块的能力，这些子模块包含横向的业务模块，也包含纵向的基础技术模块。</div><div>2.核心思想是模块化，在此基础上，降低模块间的耦合性，提高模块的复用性。</div><div><br/></div><div><b>B.利用分布式消息队列降低系统耦合性</b></div><div>1.事件驱动架构</div><div><ul><li>事件驱动架构（Event Driven Architecture）：通过在低耦合的模块之间传输事件消息，以保持模块的松散耦合，并借助事件消息的通信完成模块间合作，常用的是分布式消息队列。<br/></li><li>消息队列利用发布—订阅模式工作，消息发送者发布消息，一个或者多个消息接收者订阅消息。<br/></li></ul></div><div>2.分布式消息队列</div><div><ul><li>队列是一种先进先出的结构 ，应用程序可以通过远程访问接口使用分布式消息队列，进行消息存取操作，进而实现分布式的异步调用。<br/></li><li>消息生产者应用程序通过远程访问接口将消息推送给消息队列服务器，消息队列服务器将消息写入本地内存队列后立即返回成功响应给消息生产者。消息队列服务器根据消息订阅列表查找 订阅消息的消息消费者应用程序 ，将消息队列中的消息按照先进先出（FIFO）的原则将消息通过远程通信接口发送给消息消费者程序。<br/></li><li>分布式消息队列可以很复杂，比如可以支持ESB（企业服务总线）、支持SOA（面向服务的架构），也可以很简单使用MySQL记录：消息生产者程序将消息当作数据记录写入数据库，消息消费者程序查询数据库并按记录写入时间戳排序，就实现了一个事实上的分布式消息队列。<br/></li></ul></div><div><br/></div><div><b>C.利用分布式服务打造可复用的业务平台</b></div><div>1.分布式服务通过接口分解系统耦合性，不同子系统通过沙漠玫瑰的接口描述进行服务调用。</div><div>2.巨无霸系统的问题：编译、部署困难；代码分支管理困难；数据库连接耗尽；新增业务困难；</div><div>3.解决方案</div><div><ul><li>纵向拆分：将一个大应用拆分为多个小应用<br/></li><li>横向拆分：将复用的业务拆分出来，独立部署为分布式服务，新增业务只需要调用这些分布式服务，不需要依赖具体的模块代码<br/></li></ul></div><div>4.Web Service与企业级分布式服务</div><div>缺点：臃肿的注册与发现机制；低效的XML序列化手段；开销相对较高的HTTP远程通信；复杂的部署与维护手段；</div><div>5.大型网站分布式服务的需求与特点</div><div>负载均衡、失效转移、高效的远程通信、整合异构系统、对应用最少侵入、版本管理、实时监控</div><div>6.分布式服务框架设计：Thrift、Dubbo</div><div><br/></div><div><b>D.可扩展的数据结构</b></div><div>利用NoSQL数据库中使用的ColumnFamily（列族）设计。</div><div><br/></div><div><b>E.利用开放平台建设网站生态圈</b></div><div>1.开放平台是网站内部和外部交互的接口，外部需要面对人多的第三方开发者，内部需要面对网站内诸多的业务服务。</div><div>2.架构：API接口、协议转换、安全、审计、路由、流程</div><div><br/></div><div><b><font style="font-size: 24px;">八、固若金汤：网站的安全架构</font></b></div><div><b>A.网站应用攻击与防御</b></div><div>1.XSS攻击</div><div><ul><li>XSS攻击即跨站脚本攻击（Cross Site Script），指黑客通过篡改网页，注入恶意HTML脚本，在用户浏览网页时，控制用户浏览器进行恶意操作的一种攻击方式。<br/></li><li>一种攻击是反射型，攻击者诱使用户点击一个嵌入恶意脚本的链接，达到攻击的目的<br/></li><li>另一种攻击是持久型XSS攻击，黑客提交含有恶意脚本的请求，保存在被攻击的Web站点的数据库中，用户浏览网页时，恶意脚本被包含在正常页面中，达到攻击的目的。经常用在论坛、博客等Web应用中。<br/></li><li>防范：消毒，过滤危险字符；HttpOnly，禁止页面JS访问带有HttpOnly属性的Cookie；<br/></li></ul></div><div>2.注入攻击</div><div><ul><li>分为SQL注入和OS注入<br/></li><li>SQL注入获取数据库结构：利用开源软件程序、错误回显、盲注<br/></li><li>SQL注入防范：消毒；参数绑定，使用预编译手段，绑定参数；<br/></li></ul></div><div>3.CSRF攻击</div><div><ul><li>CSRF（Cross Site Request Forgery，跨站点请求伪造），攻击者通过跨站请求，以合法用户的身份进行非法操作。主要手法是利用跨站请求，在用户不知情的情况下，以用户的身份伪造请求，利用了浏览器Cookie或服务器Session策略，盗取用户身份。<br/></li><li>防范：表单Token、验证码、Referer check（检查HTTP请求头的Referer域中记录的请求来源）<br/></li></ul></div><div>4.其他攻击漏洞</div><div><ul><li>Error Code：错误回显、HTML注释、文件上传、路径遍历<br/></li></ul></div><div>5.Web应用防火墙：ModSecurity</div><div>6.网站安全漏洞扫描</div><div><br/></div><div><b>B.信息加密技术及密钥安全管理</b></div><div>1.单向散列加密：md5、sha等，加salt</div><div>2.对称加密：DES算法、RC算法等，加密使用同一个密钥</div><div>3.非对称加密：RSA算法</div><div>4.密钥安全管理</div><div><ul><li>把密钥和算法放在一个独立的服务器上，甚至做成一个专用的硬件设施，应用系统通过调用服务实现数据加解密。<br/></li><li>将解密算法放在应用系统中，密钥则放在独立服务器中，实际存储时，密钥被切分成数片，加密后分别保存在不同存储介质中，兼顾密钥安全性的同时又改善了性能。<br/></li></ul></div><div><br/></div><div><b>C.信息过滤与反垃圾</b></div><div>1.文本匹配：解决敏感词过滤的问题</div><div><ul><li>少量内容使用正则替换一类的就可以<br/></li><li>词多且并发高时，使用Trie树算法（双数组Trie算法）<br/></li><li>构造Hash表进行文本匹配<br/></li><li>有时还需要进行降噪处理，如”阿_拉_伯”<br/></li></ul></div><div>2.分类算法：贝叶斯算法、TAN算法、ARCS算法</div><div>3.黑名单：Hash表、布隆过滤器</div><div><br/></div><div><b>D.电子商务风险控制</b></div><div>1.风险：账户风险、买家风险、卖家风险、交易风险</div><div>2.风控</div><div><ul><li>机器自动识别高风险交易和信息会发送给风控审核人员进行人工审核，机器风控的技术和方法也不断通过人工发现的新风险类型进行逐步完善。<br/></li><li>规则引擎：当交易的某些指标满足一定条件时，就会被认为具有高风险的欺诈可能性。<br/></li><li>统计模型：使用分类算法或者更复杂的机器学习算法进行智能统计。根据历史交易中的欺诈交易信息训练分类算法，然后将经过采集加工后的交易信息输入分类算法，即可得到交易风险分值。<br/></li></ul></div><div><br/></div><div><b><font style="font-size: 24px;">九、淘宝网的架构演化案例分析</font></b></div><div>1.LAMP-&gt;JAVA/ORACLE-&gt;MySQL/NoSQL</div><div>2.业务推动技术不断进步</div><div><br/></div><div><b><font style="font-size: 24px;">十、维基百科的高性能架构设计分析</font></b></div><div><b>A.Wikipedia网站整体架构：</b>LAMP+开源产品，GeoDNS、LVS、Squid、Lighttpd、PHP、Memcached、Lucene、MySQL</div><div><br/></div><div><b>B.Wikipedia性能优化策略</b></div><div>1.前端性能优化</div><div><ul><li>前端架构的核心是反向代理服务器Squid集群，由LVS负载均衡，在反向代理之前，通过CDN返回。<br/></li><li>Wikipedia CDN缓存的准则：内容页面不包含动态信息；每个内容页面有唯一的REST风格的URL；在HTML响应头写入缓存控制信息；<br/></li></ul></div><div>2.服务端性能优化：使用APC、Imagemagick、Tex、替换PHP的字符串查找函数starter()使用更优化的算法</div><div>3.后端性能优化：</div><div><b>缓存</b></div><div><ul><li>热点特别集中的数据直接缓存到应用服务器的本地内存中<br/></li><li>缓存数据的内容尽量是应用服务器可以直接使用的格式<br/></li><li>使用缓存服务器存储session对象<br/></li><li>相比数据库，Memcached的持久化连接非常廉价，有需要就创建一个<br/></li></ul></div><div><b>MySQL</b></div><div><ul><li>使用较大的服务器内存<br/></li><li>使用RAID0磁盘阵列以回事访问<br/></li><li>将数据库事务一致性设置在较低水平<br/></li><li>如果Master数据库宕机，立即将应用切换到Salve数据库，同时关闭写服务<br/></li></ul></div><div><br/></div><div><b><font style="font-size: 24px;">十一、海量分布式存储系统Doris的高可用架构设计分析</font></b></div><div>对于一个数据存储系统而言，高可用意味着：高可用的服务、高可靠的数据</div><div><b>A.分布式存储系统的高可用架构</b></div><div>1.冗余：服务器热备、数据多份存储</div><div>2.系统整体划分：</div><div><ul><li>应用程序服务器：存储系统的客户，对系统发起数据操作请求<br/></li><li>数据存储服务器：存储系统的核心，存储数据、响应应用服务器的数据操作请求<br/></li><li>管理中心服务器：由两台机器组成的主-主热备的小规模服务器集群，负责集群管理，对数据存储集群进行健康心跳检测；集群扩容、故障恢复管理；对应用程序服务器提供集群地址配置信息服务等<br/></li></ul></div><div><br/></div><div><b>B.不同故障情况下的高可用解决方案</b></div><div>1.分布式存储系统的故障分类：瞬时故障、临时故障、永久故障</div><div>2.瞬时故障解决：多次重试</div><div>3.临时故障解决：需要人工干预，有问题服务器使用临时存储服务器</div><div>4.永久故障解决：启用备用服务器替代永久失效服务器</div><div><br/></div><div><b><font style="font-size: 24px;">十二、网购秒杀系统架构设计案例分析</font></b></div><div><b>A.秒杀活动的技术挑战：</b>对现有网站业务造成冲击、高并发下的应用，数据库负载、突然增加的网络及服务器带宽、直接下单</div><div><br/></div><div><b>B.秒杀系统的应对策略</b></div><div><ul><li>秒杀系统独立部署<br/></li><li>秒杀商品页面静态化<br/></li><li>租借秒杀活动网络带宽<br/></li><li>动态生成随机下单页面URL<br/></li></ul></div><div><br/></div><div><b>C.秒杀系统架构设计</b></div><div>1.如何控制秒杀商品页面购买按钮的点亮：使用一个JS文件，开始时修改其中内容，每次都请求，不被CDN等缓存，使用随机版本号。</div><div>2.如何只允许第一个提交的订单被发送到订单子系统：控制进入下单页面的入口，只有少数用户能进入，其他用户直接进入秒杀结束页面。比如10台服务器，每台处理10个请求，当请求超过10个，其他返回错误，再请求全局缓存记录，如果是第一个，进入订单页面，其他返回失败。</div><div><br/></div><div><b><font style="font-size: 24px;">十三、大型网站典型故障案例分析</font></b></div><div><b>A.写日志也会引发故障</b></div><div><ul><li>应用程序自己的日志输出配置和第三方组件日志输出要分别配置<br/></li><li>检查log配置文件，日志来玩吧米歇尔考虑至少为Warn<br/></li><li>需要关闭某些第三方组件可能输出的太多Error日志<br/></li></ul></div><div><br/></div><div><b>B.高并发访问数据库引发的故障</b></div><div><ul><li>首页不应该访问数据库<br/></li><li>首页应该是静态的<br/></li></ul></div><div><br/></div><div><b>C.高并发情况下锁引发的故障</b></div><div>使用锁操作要谨慎</div><div><br/></div><div><b>D.缓存引发的故障</b></div><div>缓存服务器已经是网站架构不可或缺的一部分，需要和数据库一样的级别去管理</div><div><br/></div><div><b>E.应用启动不同步引发的故障</b></div><div><br/></div><div><b>F.大文件读写独占磁盘引发的故障</b></div><div>小文件和大文件不要共用存储</div><div><br/></div><div><b>G.滥用生产环境引发的故障</b></div><div>访问生产环境要格外小心，数据库请专门的DBA维护</div><div><br/></div><div><b>H.不规范的流程引发的故障</b></div><div>代码提交前用diff命令进行比较，确认没有提交不该提交的代码；加强code review，提交前至少被一个其他工程师做过code review并共同承担因代码引起的故障责任</div><div><br/></div><div><b>I.不好的编程习惯引发的故障</b></div><div>注意对空对象、空值等的处理</div><div><br/></div><div><b><font style="font-size: 24px;">十四、架构师领导艺术</font></b></div><div><b>A.关注人而不是产品</b></div><div>1.一群优秀的人做一件他们热爱的事，一定能取得成功</div><div>2.最好的软件管理是发掘项目组每个成员的优秀潜能</div><div>3.寻找一个值得共同奋斗的目标，营造一个让大家都能最大限度发挥自我价值的工作氛围</div><div><br/></div><div><b>B.发掘人的优秀</b></div><div>1.是事情成就了人，而不是人成就了事</div><div>2.大多数人，包括我们自己，都比自己以为的更优秀，有些优秀需要在合适的环境中才会被激发出来，比如做一些有挑战的事，和更优秀的人合作，抑或拥有了超越自我的勇气</div><div>3.发掘人的优秀远比发掘优秀的人更有意义</div><div><br/></div><div><b>C.共享美好蓝图</b></div><div>1.蓝图应该是表述清楚的：产品要做什么、不做什么、要达到什么业务目标</div><div>2.蓝图应该是形象的：产品能为用户创建什么价值、能实现什么样的市场目标、产品最终会长什么样</div><div>3.蓝图应该是简单的：一句话话说明白：我们在干什么</div><div>4.架构师要保持对目标蓝图的关注，对任何偏离蓝图的设计和决定保持警惕，错误的偏离要及时修正，必要的变更要经过大家讨论，并且需要重新获得大家的认同。</div><div><br/></div><div><b>D.共同参与架构</b></div><div>1.不要只有架构师一个人拥有架构</div><div>2.让其他人维护框架与架构文档</div><div><br/></div><div><b>E.学会妥协</b></div><div>1.对架构和技术方案的反对意见，其实意味着架构和技术方案被关注、被试图理解和接受。架构师不应过于敏感，应该坦率分享意见，求同存异</div><div>2.对于技术细节的争论应该立即验证而不是继续讨论</div><div>3.当大家不在讨论架构的时候，表明架构已经融入到项目、系统和开发者中了，架构师越早被遗忘表明架构越成功</div><div><br/></div><div><b>F.成就他人</b></div><div>1.我们的工作不仅是生产产品，还要成就人，并最终成就我们自己</div><div>2.做成一个项目不但要给客户创造价值，为公司盈利，还要让项目成员获得成长</div><div>3.架构师作为团队的技术领导者，在项目过程中不要去试图控制什么，带着一个弹性的计划和蓝图推进，团队会管好他们自己</div><div><br/></div><div><b><font style="font-size: 24px;">十五、网站架构师职场攻略</font></b></div><div><ul><li>开发软件的目的是为了解决现实世界的问题，但是很多时候人们并不清楚真正的问题是什么。<br/></li><li>软件开发过程中也会遇到很多问题，需要协调各方面的利益关系获取尽可能大的支持，需要平衡客户需求、软件产出、开发资源之间的关系，需要搞定许多事情才能实现软件设计最初的蓝图。<br/></li></ul></div><div><b>A.发现问题，寻找突破</b></div><div>1.所谓问题，就是体验——期望，当体验不能满足期望，就会觉得出了问题。消除问题有两种手段：改善体验或者降低期望。降低期望只是回避了问题，而如果直面期望和体验之间的差距，就会发现问题所在，找到突破点。</div><div>2.新员工首先要做的事情是融入团队</div><div>3.新员工最不需要做的事情就是证明自己的能力。</div><div><br/></div><div><b>B.提出问题，寻求支持</b></div><div>1.问题被发现，它只是问题发现者的问题，而不是问题拥有者的问题，如果想要解决一个问题，就必须提出这个问题，让问题的拥有者知道问题的存在。</div><div>2.提出问题Tips：</div><div><ul><li>把“我的问题”表述成“我们的问题”<br/></li><li>给上司提封闭式问题（给出AB方案让上司选择哪个更好），给下属提开放式问题<br/></li><li>指出问题而不是批评人<br/></li><li>用赞同的方式提出问题<br/></li></ul></div><div>3.所谓直言有讳是指想要表达的意图要直截了当说明白，不要兜圈子，但是在表达方式上要有所避讳，照顾到当事人的感受</div><div><br/></div><div><b>C.解决问题，达成绩效</b></div><div>1.解决我的问题之前，先解决你的问题</div><div><ul><li>你帮别人解决了问题，别人也会帮你解决问题<br/></li><li>在帮别人解决问题的过程中，熟悉了情况<br/></li><li>解决别人的问题用的是你的解决方案，这个方案在你的控制之中<br/></li></ul></div><div>2.适当的逃避问题</div><div><br/></div><div><b><font style="font-size: 24px;">十六、漫话网站架构师</font></b></div><div><b>A.按作用划分架构师</b></div><div>设计型架构师、救火型架构师、布道型架构师、Geek型架构师</div><div><br/></div><div><b>B.按效果划分架构师</b></div><div>夏尔巴人架构师：通常会开发项目中最具技术难度和挑战性的模块、斯巴达人架构师、达官贵人架构师</div><div><br/></div><div><b>C.按职责角色划分架构师</b></div><div>产品架构师：参与产品的整个生命周期、基础服务架构师（平台型架构师）、基础设施架构师</div><div><br/></div><div><b>D.按关注层次划分架构师</b></div><div>只关注功能的架构师、关注非功能的架构师、关注团队组织与管理的架构师、关注产品运营的架构师、关注产品未来的架构师</div><div><br/></div><div><b>E.按口碑划分架构师</b></div><div>最好的架构师、好的架构师、一般的架构师、差的架构师、最差的架构师</div><div><br/></div><div><b>F.非主流方式划分架构师</b></div><div>普通架构师、文艺架构师、1+1架构师</div><div><br/></div><div><b><font style="font-size: 24px;">附录A：大型网站技术一览</font></b></div><div><b>A.前端架构</b></div><div>浏览器优化技术、CDN、动静分离，静态资源独立部署、图片服务、反射代理 、DNS</div><div><br/></div><div><b>B.应用层架构</b></div><div>开发框架、页面渲染、负载均衡、Session管理、动态页面静态化、业务拆分、虚拟化服务器</div><div><br/></div><div><b>C.服务层架构</b></div><div>分布式消息、分布式服务、分布式缓存、分布式配置</div><div><br/></div><div><b>D.存储层架构</b></div><div>分布式文件、关系数据库、NoSQL数据库、数据同步</div><div><br/></div><div><b>E.后台架构</b></div><div>搜索引擎、数据仓库、推荐系统</div><div><br/></div><div><b>F.数据采集（日志）与监控</b></div><div>浏览器数据采集、服务器业务采集、服务器性能数据采集、系统监控、系统报警</div><div><br/></div><div><b>G.安全架构</b></div><div>Web攻击、数据保护</div><div><br/></div><div><b>H.数据中心机房架构</b></div><div>机房、机柜、服务器</div><div><br/></div></span>
</div></body></html> 