<html>
<head>
  <title>代码审计企业级web代码安全架构</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/608449 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
	body, td {
	  font-family: 微软雅黑;
	  font-size: 12pt;
	}
  </style>
</head>
<body>
<a name="2020"/>
<h1>代码审计企业级web代码安全架构</h1>

<div>
<span><div><b><font style="font-size: 24px;">一、代码审计环境</font></b></div><div><b><br/></b></div><div><b>A.phpStudy：</b></div><div>wget -c <a href="http://lamp.phpstudy.net/phpstudy.bin">http://lamp.phpstudy.net/phpstudy.bin</a></div><div>chmod +x oh-study.bin</div><div>./phpstudy.bin</div><div><br/></div><div><b>B.危险PHP配置:</b></div><div>1.gegister_globals-5.4.0移除了</div><div>2.allow_url_include-5.2.0后默认为off</div><div>3.magic_quotes_gpc-5.4之后取消，不会过滤$_SERVER变量</div><div>4.magic_quotes_runtime-5.4后取消，过滤文件或数据库的特殊符号，某些情况下这个函数可以绕过</div><div>5.magic_quotes_sybase-5.4后取消，为on时会覆盖掉_gpc，仅转义空字符及单引号变双引号</div><div>6.safe_mode-5.4后取消，on时会影响所有文件操作函数以及popen()、system()、exec()等执行函数</div><div>7.open_dir，PHP可访问目录</div><div>8.disable_functions，禁用函数，一定要把dl()函数加入到其中</div><div>9.display_errors和error_reporting错误显示，生产环境中建义display_errors设置为off，设置为on是可以设置error_reporting配合使用</div><div><br/></div><div><b><font style="font-size: 24px;">三、通用代码审计思路</font></b></div><div><br/></div><div><b>A.常见的代码审计思路有以下四种：</b></div><div>1.根据敏感关键字回溯参数传递过程</div><div>2.查找可控变量，正向追踪变量传递过程</div><div>3.寻找敏感功能点，通读功能点代码</div><div>4.直接通读全文代码</div><div><br/></div><div><b>B.敏感函数回溯参数过程</b></div><div>1.由于函数的使用不当。使用SQL注入。利用HTTP头里面的HTTP_CLIENT_IP和HTTP_X_FROWORDFOR等。</div><div>2.优点是只需搜索相应敏感关键字，即可快速地挖掘想要的漏洞，具有可定向挖掘和高效、高质量的优点</div><div>3.缺点为由于没有通读代码，对程序 的整体框架了解不够深入，在挖掘漏洞时定位利用点会花费时间，另外对连加漏洞挖掘覆盖不同</div><div>4.seay源代码审计系统进行演示</div><div><br/></div><div><b>C.通读全文代码</b></div><div>1.在企业中做自身产品的代码审计时，我们需要了解整个应用的业务逻辑，才能挖掘到更多有价值的漏洞</div><div>2.首先看程序的大体代码结构，如主目录文件，模块目录文件，文件大小，创建时间等</div><div>①函数集文件：通常包含functions或common等关键字的</div><div>②配置文件：通常命名中包含config，如果使用双引号，可能会存在代码执行漏洞</div><div>③安全过滤文件：通常包含filter、safe、check等</div><div>④index文件：程序的入口文件，可以大致了解 整个程序的架构、运行的流程、包含到的文件</div><div>3.通读全文代码的好处：可以更好地了解程序的架构以及业务逻辑，能够挖掘到列多、更高质量的逻辑漏洞，缺点是花费时间比较多，程序大的话也会很累</div><div><br/></div><div><b>D.根据功能点定向审计</b></div><div>1.几个功能点经常会出现的漏洞：</div><div>①文件上传功能：文件格式没有限制，文件名SQL注入</div><div>②文件管理功能：文件名或者文件路径直接在参数中传递，很有可能会存在任意文件操作的漏洞；XSS漏洞，程序会在页面输出文件名而忽视了文件名的过滤</div><div></div><div><div></div></div><div>③登录认证功能：cookie存了用户信息并且未加密</div><div>④找回密码功能：重置管理员密码；验证码爆破，没有验证码错误次数和有效时间</div><div><br/></div><div><b><font style="font-size: 24px;">四、漏洞挖掘与防范（基础篇）</font></b></div><div><br/></div><div><b>A.SQL注入漏洞</b></div><div>1.普通注入：直接注入union查询就可以查询数据库</div><div>2.宽字节：利用gbk数据库漏洞</div><div>3.二次urldecode注入：利用系统addslashes后再使用urldecode来破解，如%2527先addslashe之后再执行urldecod就为单引号</div><div>4.漏洞防范：</div><div>①gpc/rutime魔术引号</div><div>②过滤函数和类：addslashes、mysql_[real_]escape_string、intval等</div><div>③PDO prepare预编译：php5.3.6之前注意还有宽字节危险，需要指定$pdo-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES,false)</div><div><br/></div><div><b>B.XSS漏洞</b></div><div>1.跨站脚本攻击，有两种情况一是通过外部输入然后直接浏览器端触发，即反射型XSS；另一种帽是先把利用代码保存在数据库或文件中。危害：前端页面能做的事它都能做。</div><div>2.注意输出，如echo、print、print_r等，留意用户输入的地方</div><div>3.漏洞防范：</div><div>①特殊字符，在输出和二次调用的时候进行如HTML实体一类的转码：单引号、双引号、尖括号、反斜杠、冒号、and符、#号</div><div>②用正则匹配做白名单，如果不在白名单中就直接拦截掉而不是替换成空</div><div><br/></div><div><b>C.CSRF漏洞</b></div><div>1.全称：Cross-site request forgery，跨站请求伪造。劫持其他用户去进行一些请求。</div><div>2.漏洞防范：</div><div>①增加token/referer验证：服务器在接收操作请求的时候只要验证下这个字符串是不是上次访问留下的即可判断是不是可信请求，因为如果没有访问上一个页面，是无法得到这个token的</div><div>②增加验证码：敏感操作页面适合，例如登录等，但不适合所有页面，因为需要用户填写</div><div><br/></div><div><i>/daimashengji/1.php</i></div><div><br/></div><div><b><font style="font-size: 24px;">五、漏洞挖掘与防范（进阶篇）</font></b></div><div><br/></div><div><b>A.文件操作漏洞</b></div><div>1.包括：文件包含、文件读取、文件删除、文件修改以及文件上传</div><div>2.渗透过程中文件包含漏洞大多可以直接利用获取webshell，漏洞大多出现在模块加载、模板加载以及cache调用的地方</div><div>3.文件读取（下载漏洞）：部分程序在下载文件或者读取显示文件的时候，读取文件的参数filename直接在请求里面传递，可以直接传入想要读取的文件路径即可利用</div><div>4.文件上传：如果能把文件上传到管理员或者应用程序不想让你上传的目录，那就是存在文件上传漏洞</div><div>目前存在较多的是黑名单过滤存在绕过导致文件上传漏洞</div><div>①未过滤文件类型</div><div>②黑名单扩展名过滤</div><div>③文件头、content-type验证绕过</div><div>5.文件操作漏洞防范</div><div>主要利用点：</div><div>①由越权操作引起可以操作未授权操作的文件</div><div>②要操作更多文件需要跳转目录</div><div>③大多都是直接在请求中传入文件名</div><div>思考防御手段：</div><div>①对权限的管理要合理</div><div>②有的文件操作是不需要直接传入文件名的</div><div>③要避免目录跳转的问题</div><div>6.文件上传漏洞：主要两种利用方式，上传的文件类型难不严谨和写一篇文件不规范。</div><div>白名单方式过滤文件扩展名，使用in_array或者三等于来对比扩展名</div><div>保存上传的文件时重命名文件，随机命名</div><div><br/></div><div><b>B.代码执行漏洞</b></div><div>1.是可以把代码注入应用中最终到WebServer上去执行，如果没有特殊的过滤，相当于直接有一个Web后门存在，主要由eval()、assert()、preg_replace()、call_user_func()、call_user_func_array()、array_map()等</div><div>2.防范：采用参数白名单过滤，在可预测满足正常业务的参数情况下。</div><div><br/></div><div><b>C.命令执行漏洞</b></div><div>1.利用可以执行系统或应用指令的漏洞，主要是基于一些函数的参数过滤不严导致的，包括：system()、exec()、shell_exec()、passthru()、pcntl_exec()、popen()、proc_open()，另外反引号(`)也可以执行命令，调用的是shell_exec()函数</div><div>2.防范：命令防注入函数escapeshellcmd()、escapeshellarg()，参数白名单</div><div><br/></div><div><i>/daimashengji/2.php</i></div><div><br/></div><div><b><font style="font-size: 24px;">六、漏洞挖掘与防范（深入篇）</font></b></div><div><br/></div><div><b>A.变量覆盖漏洞</b></div><div>1.指的是可以用我们自定义的参数值替换程序原有的变量值，变量覆盖漏洞通常需要结合程序的其他功能来实现完整攻击，变量覆盖漏洞通常需要结合程序的其他功能来实现完整攻击。常见函数有extract()函数和pase_str()。import_request_variables()，5.4以后版本已经取消这个函数。</div><div>2.防范：</div><div>推荐使用原始变量</div><div>验证变量的存在：使用extract()每二个参数为EXTR_SKIP</div><div><br/></div><div><b>B.逻辑处理漏洞</b></div><div>1.in_array()会自己转换类型</div><div>2.is_numeric()当传入参数为hex编码时则直接通过并返回true</div><div>3.双等于与三等于：双等于在判断等于之前会先做变量类型转换，而三等于则不会，由于数据类型被改变，所以双等于在判断的时候可能存在安全风险</div><div>4.未exit或return引发的安全问题</div><div>5.防范：</div><div>①要深入熟悉业务逻辑</div><div>②要注意多熟悉函数 的功能和差异</div><div><br/></div><div><b>C.会话认证漏洞</b></div><div>1.cookie、session、sos、oauth、openid等，cookie的漏洞比较多</div><div>2.cookie出现问题比较多的是cookie的SQL注入等常见漏洞，以及Web应用程序在服务端直接读取cookie的用户名或者ID值来操作当前这个用户的数据。</div><div>3.防范：</div><div>所有用户输入的值都是不可信的，可以利用cookie和session结合起来使用，敏感数据不要放到cookie中</div><div><br/></div><div></div><div><i>/daimashengji/3.php</i><br/></div><div><br/></div><div><b><font style="font-size: 24px;">七、二次漏洞审计</font></b></div><div><br/></div><div><b>A.二次漏洞</b></div><div><br/></div><div>1.什么是二次漏洞：需要先构造好利用代码写入网站 保存，在第二次或多次请求后调用攻击代码触发或者修改配置触发的漏洞。归根结底是开发者在可信数据的逻辑上考虑不全面，认为这个数据来源或者这个配置是不会存在问题的，而没有想到另外一个漏洞能够修改这些“可信”数据。</div><div><br/></div><div><b><font style="font-size: 24px;">八、代码审计小技巧</font></b></div><div><br/></div><div><b>A.钻GPC等转义的空子</b></div><div>1.在PHP5之后用$_SERVER取到header字段不受GPC影响，在header注入里最常见的是user-agent、referer以及client-ip/x-forward-for，同样$_FILES变量也一样不受GPC保护</div><div><br/></div><div><b>B.神奇的字符串</b></div><div>1.字符串处理程序错误信息可能导致目录暴露</div><div>2.%00字符串截断，%00在URL截断后为\0，在c语言中就是字符串结束符，php5.3后已修复文件名，addslashes()可以过滤</div><div>3.iconv函数字符编码转换：遇到不能处理的字符串则后续字符串会不被处理</div><div><br/></div><div><b>C.php://输入输出流</b></div><div>1.php://filter如果有远程文件保护漏洞可能会被执行，如include($_GET[‘f’])，$_GET[‘f’]=‘php://filter/convert.base64-encode/resource=1.php'</div><div><br/></div><div><b>D.PHP代码解析标签</b></div><div>1.注意&lt;?php ?&gt;、&lt;?…?&gt;、&lt;%…%&gt;，以及最重要的&lt;script language=“php”&gt;….&lt;/script&gt;</div><div><br/></div><div><b>E.fuzz漏洞发现</b></div><div>1.fuzz指的是对特定目标的模糊测试，指的是特定请求，不同于漏洞扫描器进行指漏洞扫描，工具有pywebfuzz等。</div><div><br/></div><div><b>F.不严谨的正则表达式</b></div><div>1.没有使用^和$限定匹配开始位置</div><div>2.特殊字符未转义，如.忘了加\.</div><div><br/></div><div><b>G.十余种MySQL报错注入</b></div><div>floor()、extractvalue()、updatexml()、GeometryCollection()、polygon()、multipoint()、multilinestring()、multipolygon()、linestring()、exp()</div><div><br/></div><div><b>H.Windows FindFirstrFile利用</b></div><div>Windows在搜索文件时使用到了FindFirstFile这个winapi函数，会到一个文件夹包括子文件夹中搜索指定文件，只要将文件名不可知的部分用字符“&lt;”或“&gt;”代替即可。</div><div><br/></div><div><b>I.PHP可变变量</b></div><div>1.PHP的一种特性，一个变量的变量名可以动态地设置和使用。</div><div>2.PHP中的双引号中的变量是可以解析的，不影响PHP规则就可以使用”${@….}”来运行php代码</div><div><br/></div><div><i>/daimashengji/4.php</i><br/><br/></div><div><b><font style="font-size: 24px;">九、参数的安全过滤</font></b></div><div><br/></div><div><b>A.第三方过频函数与类</b></div><div>研究discuz等开源系统的过滤类</div><div><br/></div><div><b>B.内置过滤函数</b></div><div>1.SQL注入过滤函数 ：addslashes()、mysql_real_escape_string()以及mysql_escape_string()，作用都是给字符串添加反斜杠来轮询掉单引号、双引号、反斜线以及空字符串NULL。</div><div>2.XSS过滤函数：htmlspecialchars()和strip_tags()，htmlspecialchars()是将字符串中的特殊字符转换成HTML实体编码，而strip_tags()是用来去掉HTML和PHP标记。</div><div>3.命令执行过滤函数：escapeshellcmd()和escapeshellarg()</div><div><br/></div><div><b><font style="font-size: 24px;">十、使用安全的加密算法</font></b></div><div><br/></div><div><b>A.对称加密</b></div><div>1.通过密钥加密，但也可以解密，取决于密钥的管理</div><div>2.3DES加密、AES加密</div><div><br/></div><div><b>B.非对称加密</b></div><div>1.使用两个密钥，公钥用来加密，私钥用于解密</div><div>2.RSA加密：可以使用phpseclib来测试，直接就可以使用</div><div><br/></div><div><b>C.单向加密</b></div><div>1.MD5、SHA1</div><div>2.不加salt的非常不安全</div><div><br/></div><div><b><font style="font-size: 24px;">十一、业务功能安全设计</font></b></div><div><br/></div><div><b>A.验证码</b></div><div>1.可以解决撞库、垃圾注册等，有图片、滑动、短信/邮箱/电话、二维码等分类，但80%以上存在可以爆破和简单识别的问题</div><div>2.设计一个强壮的验证码：</div><div>①最重要的，设计验证码错误次数</div><div>②不要把验证码放到html页面或者cookie中</div><div>③验证码要设置只能请求一次，不管对错都要强制刷新</div><div>④短信或者邮件验证码必须要6位以上字母和数字混合，图片或者语音验证码要加强混淆干扰</div><div>⑤验证码要动态生成，不能统一生成多次调用</div><div><br/></div><div><b>B.用户登录</b></div><div>1.撞库漏洞</div><div>①用户名和密码错误次数都无限制</div><div>②单时间段内用户的密码错误次数限制</div><div>③单时间段内IP登录错误次数限制</div><div>解决方案：使用登录验证码和多因素认证。</div><div>2.API登录</div><div>①登录密钥需要不可预测并且不固定，生成key的算法中加入随机字符</div><div>②API接口禁止搜索引擎收录</div><div>③登录密钥当次绑定当前主机，换机器不可用</div><div><br/></div><div><b>C.用户注册</b></div><div>①设计验证码</div><div>②采集用户机器唯一识别码，拦截短时间内多次注册</div><div>③根据帐号格式自学习识别垃圾帐号</div><div>④防止SQL注入漏洞与XSS漏洞</div><div><br/></div><div><b>D.密码找回</b></div><div>①接收验证码的邮箱和手机号不可由用户控制 </div><div>②加强验证凭证复杂度，防止被暴力破解</div><div>③限制验证凭证错误次数</div><div>④验证凭证设置失效时间</div><div>⑤验证凭证不要保存在页面</div><div>⑥输入用户邮箱或ID、手机号取验证凭证的地方需要设置验证码防止短信炸弹和批量找回等</div><div>⑦验证凭证跟用户名、用户ID、用户邮箱绑定，找回密码时验证当前凭证是否是当前用户的</div><div><br/></div><div><b>E.资料查看与修改</b></div><div>①用户资源ID（订单ID、地址ID等）绑定到用户，只允许有权限的用户查看</div><div>②当前用户信息存储到session，不放到request中，避免攻击者修改当前用户ID</div><div><br/></div><div><b>F.投票/积分/抽奖</b></div><div>①机器识别码验证，每台机器都可以根据硬件信息生成唯一的识别码</div><div>②操作需要登录，当前用户信息从session中读取</div><div><br/></div><div><b>G.充值支付</b></div><div>①保证数据可信，商品单价及总价不可从客户端获取</div><div>②购买数量不能小于等于0</div><div>③账户支付锁定机制，当一个支付操作开始就应该立马锁定当前账户，不能同时两个后端请求对余额进行操作</div><div><br/></div><div><b>H.私信及反馈</b></div><div>特殊字符过滤和使用白名单黑名单结合的方式</div><div><br/></div><div><b>I.远程地址访问</b></div><div>1.远程地址访问：SSRF漏洞</div><div><br/></div><div><b>J.文件管理</b></div><div>①禁止写入脚本可在服务器端执行的文件</div><div>②限制文件管理功能操作的目录</div><div>③限制文件管理功能访问权限</div><div>④禁止上传特殊字符文件名的文件</div><div><br/></div><div><b>K.数据库管理</b></div><div>①限制可以损我的数据库表</div><div>②限制备份到服务器上的文件名，需要系统随机生成类似md5并且长度不能低于16位，扩展名不能自定义</div><div><br/></div><div><b>L.命令/代码执行</b></div><div>①严格控制该功能访问权限，建议高权限才能访问</div><div>②在满足业务需求的情况下，可以设置命令白名单，命令直接写死在代码中更好</div><div>③在命令及代码执行功能设置独立密码</div><div>④代码执行功能限制脚本可访问的路径</div><div>⑤在满足需求的情况下限制当前执行命令的系统用户权限</div><div><br/></div><div><b>M.文件/数据库备份</b></div><div>①进行权限控制</div><div>②文件名随机生成，不可预测</div><div><br/></div><div><b>N.API</b></div><div>①访问权限控制</div><div>②防止敏感信息泄漏</div><div>③SQL注入等常规漏洞</div><div><br/></div><div><b><font style="font-size: 24px;">十二、应用安全体系建设</font></b></div><div>横向细化策略和纵深策略。横向细化策略的精髓在于坚持能杀掉一个是一个的原则，依靠规则量来填补空洞，规则做得越细，拦掉的攻击越多。纵深策略是假设上一层防御策略失效而设计的内网防御策略。<br/></div><div><br/></div><div><b>A.用户密码安全策略</b></div><div>①强制密码使用8位以上的“大小写字母+数字 +特殊字符”的组合</div><div>②禁止使用123456及1qaz2wsx等弱口令</div><div>③禁止用户名和密码相同，或者存在较大相似度</div><div><br/></div><div><b>B.前后台用户分表</b></div><div><br/></div><div><b>C.后台地址隐藏</b></div><div><br/></div><div><b>D.密码加密存储方式</b></div><div>使用salt再进行md5或sha1加密</div><div><br/></div><div><b>E.登录限制</b></div><div>①限制登录ip</div><div>②双因素谁</div><div><br/></div><div><b>F.API站库分离</b></div><div>单独跑一台API服务器，数据库服务器配置只允许API服务器访问</div><div><br/></div><div><b>G.慎用第三方服务</b></div><div><br/></div><div><b>H.严格的权限控制</b></div><div><br/></div><div><b>I.敏感操作多因素验证</b></div><div>添加多种，操作多次验证权限，包括：手机短信验证码、手机语音验证码、手机APP动态令牌、邮箱验证码、实体令牌卡、电子图片令牌卡、硬件令牌</div><div><br/></div><div><b>J.应用自身的安全中心</b></div><div>输入的特殊字符过滤、输出过滤、异常访问检测、自身安全检测等等，自身安全检测的方式有：木马查杀、弱后台地址检测、弱口令检测等等。</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div> </div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 